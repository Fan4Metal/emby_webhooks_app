<!DOCTYPE html>
<html lang="ru">
<head>
    <meta charset="UTF-8">
    <title>Emby Webhooks Monitor</title>
    <meta name="viewport" content="width=device-width, initial-scale=1.0">

    <!-- Favicon -->
    <link rel="icon" type="image/png" sizes="32x32" href="/static/favicon.png">
    <link rel="icon" type="image/png" sizes="512x512" href="/static/icon-512.png">
    <link rel="apple-touch-icon" sizes="512x512" href="/static/icon-512.png">
    <link rel="manifest" href="/static/manifest.json">

    <style>
        body {
            font-family: Arial, sans-serif;
            margin: 10px;
            font-size: 16px;
            background: #fafafa;
            color: #222;
        }

        h1 {
            font-size: 20px;
            margin-bottom: 10px;
        }

        .controls {
            margin-bottom: 10px;
        }

        button {
            padding: 10px 16px;
            font-size: 16px;
            border: none;
            background: #d9534f;
            color: white;
            border-radius: 6px;
            cursor: pointer;
        }

        button:hover {
            background: #c9302c;
        }

        .table-container {
            overflow-x: auto;
        }

        table {
            width: 100%;
            border-collapse: collapse;
            table-layout: fixed;
        }
        th, td {
            border: 1px solid #ddd;
            padding: 6px;
            font-size: 13px;
            overflow: hidden;
            text-overflow: ellipsis;
            white-space: nowrap;
        }
        th {
            background: #f4f4f4;
        }
        td:first-child, th:first-child {
            text-align: center;
            width: 40px;
        }
        td:nth-child(2), th:nth-child(2) {
            width: 160px;
            white-space: normal;
            word-wrap: break-word;
        }
        td:last-child, th:last-child {
            text-align: right;
            width: 140px;
        }

        /* –¶–≤–µ—Ç–∞ —Å–æ–±—ã—Ç–∏–π */
        .event-start { background: #dff0d8; }   /* –∑–µ–ª—ë–Ω—ã–π */
        .event-pause { background: #fcf8e3; }   /* –∂—ë–ª—Ç—ã–π */
        .event-stop  { background: #f2dede; }   /* –∫—Ä–∞—Å–Ω—ã–π */

        /* –ü–æ–¥—Å–≤–µ—Ç–∫–∞ —Å—Ç—Ä–æ–∫–∏ –ø—Ä–∏ –Ω–∞–≤–µ–¥–µ–Ω–∏–∏ */
        tr:hover {
            background: #e9ecef !important;
        }

        @media (max-width: 480px) {
            body { font-size: 13px; }
            td, th { padding: 4px; }
            td:nth-child(2), th:nth-child(2) { font-size: 12px; }
            td:last-child, th:last-child { font-size: 11px; }
        }
    </style>
</head>
<body>
    <h1>üì∫ Emby Webhooks Monitor</h1>

    <div class="controls">
        <form method="post" action="/clear" onsubmit="return confirm('–¢–æ—á–Ω–æ –æ—á–∏—Å—Ç–∏—Ç—å –≤—Å–µ –ª–æ–≥–∏?');">
            <button type="submit">üóë –û—á–∏—Å—Ç–∏—Ç—å –ª–æ–≥</button>
        </form>
    </div>

    <div class="table-container">
        <table id="webhook-table">
            <thead>
                <tr>
                    <th style="width: 40px; text-align:center;">üé¨</th>
                    <th style="width: 160px;">–°–æ–æ–±—â–µ–Ω–∏–µ</th>
                    <th style="width: 100px;">–î–∞—Ç–∞</th>
                </tr>
            </thead>
            <tbody>
                <!-- —Å—Ç—Ä–æ–∫–∏ –±—É–¥—É—Ç –ø–æ–¥—Å—Ç–∞–≤–ª—è—Ç—å—Å—è —Å–∫—Ä–∏–ø—Ç–æ–º -->
            </tbody>
        </table>
    </div>

    <script>
        const eventIcons = {
            "playback.start": "‚ñ∂Ô∏è",
            "playback.stop": "‚èπ",
            "playback.pause": "‚è∏",
            "playback.unpause": "‚ñ∂Ô∏è",
            "system.notification": "üîî"
        };

        // –ü—Ä–µ–æ–±—Ä–∞–∑—É–µ–º UTC –≤ –ª–æ–∫–∞–ª—å–Ω–æ–µ –≤—Ä–µ–º—è
        function utcToLocal(utcString) {
            // –†–∞–∑–±–∏—Ä–∞–µ–º —Å—Ç—Ä–æ–∫—É —Ñ–æ—Ä–º–∞—Ç–∞ "dd.mm.yyyy HH:MM:SS"
            const parts = utcString.split(' ');
            const dateParts = parts[0].split('.');
            const timeParts = parts[1].split(':');
        
            // –°–æ–∑–¥–∞–µ–º –¥–∞—Ç—É –∫–∞–∫ UTC
            const utcDate = new Date(Date.UTC(
                parseInt(dateParts[2]), // –≥–æ–¥
                parseInt(dateParts[1]) - 1, // –º–µ—Å—è—Ü (0-11)
                parseInt(dateParts[0]), // –¥–µ–Ω—å
                parseInt(timeParts[0]), // —á–∞—Å—ã
                parseInt(timeParts[1]), // –º–∏–Ω—É—Ç—ã
                parseInt(timeParts[2])  // —Å–µ–∫—É–Ω–¥—ã
            ));

            // –ë—Ä–∞—É–∑–µ—Ä –∞–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–∏ –ø—Ä–µ–æ–±—Ä–∞–∑—É–µ—Ç –≤ –ª–æ–∫–∞–ª—å–Ω–æ–µ –≤—Ä–µ–º—è
            return utcDate;
        }

        // –ó–∞–≥—Ä—É–∂–∞–µ–º –¥–∞–Ω–Ω—ã–µ –∏–∑ API
        async function loadData() {
            const response = await fetch('/data');
            const data = await response.json();
            const tbody = document.querySelector('#webhook-table tbody');
            tbody.innerHTML = '';

            data.forEach(row => {
                const tr = document.createElement('tr');

                // –¶–≤–µ—Ç —Å—Ç—Ä–æ–∫–∏
                let cls = "";
                if (row.event === "playback.start" || row.event === "playback.unpause") {
                    cls = "event-start";
                } else if (row.event === "playback.pause") {
                    cls = "event-pause";
                } else if (row.event === "playback.stop") {
                    cls = "event-stop";
                }
                tr.className = cls;

                const icon = eventIcons[row.event] || "üì∫";

                const rawDate = row.date;
                const localDate = utcToLocal(rawDate)
                
                tr.innerHTML = `
                    <td>${icon}</td>
                    <td>${row.title}</td>
                    <td>${localDate.toLocaleString()}</td>
                `;
                tbody.appendChild(tr);
            });
        }

        loadData();
        setInterval(loadData, 10000);
    </script>
</body>
</html>
